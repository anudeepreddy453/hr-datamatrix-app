from app import app, db, User
from werkzeug.security import generate_password_hash
from datetime import datetime

with app.app_context():
    # Delete all users
    User.query.delete()
    db.session.commit()
    
    # Create user
    user = User(
        name='Test Admin',
        email='admin@test.com',
        password_hash=generate_password_hash('admin123'),
        role='admin',
        department='IT',
        status='active',
        created_at=datetime.utcnow(),
        approved_at=datetime.utcnow()
    )
    
    db.session.add(user)
    db.session.commit()
    print("‚úÖ User created")
    
    # Test password
    test_user = User.query.filter_by(email='admin@test.com').first()
    if test_user:
        result = test_user.check_password('admin123')
        print(f"‚úÖ Password test: {result}")
        if result:
            print("üéâ SUCCESS! Login should work now!")
        else:
            print("‚ùå Still failing - need to check app.py")
    else:
        print("‚ùå User not found")


############################
from app import app, db, User
from werkzeug.security import generate_password_hash
from datetime import datetime

with app.app_context():
    # Create all database tables
    db.create_all()
    print("‚úÖ Database tables created")
    
    # Create all users with strong passwords
    users = [
        {
            "name": "Admin User",
            "email": "admin@company.com",
            "password": "Admin@123",
            "role": "admin",
            "department": "HR"
        },
        {
            "name": "Priya Sharma",
            "email": "priya.sharma@ccr.com",
            "password": "Priya@123",
            "role": "admin",
            "department": "CCR"
        },
        {
            "name": "Rohan Mehta",
            "email": "rohan.mehta@i2r.com",
            "password": "Rohan@123",
            "role": "admin",
            "department": "I2R"
        },
        {
            "name": "Anjali Verma",
            "email": "anjali.verma@mkd.com",
            "password": "Anjali@123",
            "role": "admin",
            "department": "MKD"
        },
        {
            "name": "Vikram Rao",
            "email": "vikram.rao@bacardi.com",
            "password": "Vikram@123",
            "role": "admin",
            "department": "Bacardi"
        },
        {
            "name": "Sneha Kapoor",
            "email": "sneha.kapoor@xone.com",
            "password": "Sneha@123",
            "role": "admin",
            "department": "Xone"
        },
        {
            "name": "Arjun Malhotra",
            "email": "arjun.malhotra@cis.com",
            "password": "Arjun@123",
            "role": "admin",
            "department": "CIS"
        },
        {
            "name": "Neha Singh",
            "email": "neha.singh@dir.com",
            "password": "Neha@123",
            "role": "admin",
            "department": "DIR"
        },
        {
            "name": "Karan Patel",
            "email": "karan.patel@cqis.com",
            "password": "Karan@123",
            "role": "admin",
            "department": "CQIS"
        },
        {
            "name": "Meera Nair",
            "email": "meera.nair@osd.com",
            "password": "Meera@123",
            "role": "admin",
            "department": "OSD"
        },
        {
            "name": "Suresh Reddy",
            "email": "suresh.reddy@dat.com",
            "password": "Suresh@123",
            "role": "admin",
            "department": "DAT"
        },
        {
            "name": "Aditi Joshi",
            "email": "aditi.joshi@dlf.com",
            "password": "Aditi@123",
            "role": "admin",
            "department": "DLF"
        },
        {
            "name": "Kavya Menon",
            "email": "kavya.menon@riskweb.com",
            "password": "Kavya@123",
            "role": "admin",
            "department": "Riskweb"
        },
        {
            "name": "Test User",
            "email": "test@test.com",
            "password": "Test@123",
            "role": "user",
            "department": "IT"
        },
        {
            "name": "HR Manager",
            "email": "hr@test.com",
            "password": "HR@123",
            "role": "hr_manager",
            "department": "HR"
        }
    ]
    
    # Create all users
    created_count = 0
    for user_data in users:
        try:
            user = User(
                name=user_data['name'],
                email=user_data['email'],
                password_hash=generate_password_hash(user_data['password']),
                role=user_data['role'],
                department=user_data['department'],
                status='active',
                created_at=datetime.utcnow(),
                approved_at=datetime.utcnow()
            )
            
            db.session.add(user)
            created_count += 1
            print(f"‚úÖ Created: {user_data['email']} / {user_data['password']}")
            
        except Exception as e:
            print(f"‚ùå Error creating {user_data['email']}: {e}")
    
    # Commit all changes
    db.session.commit()
    print(f"\nüéâ Successfully created {created_count} users!")
    
    # Test first user
    test_user = User.query.filter_by(email='admin@company.com').first()
    if test_user:
        result = test_user.check_password('Admin@123')
        print(f"‚úÖ Password test: {result}")
        if result:
            print("üéâ SUCCESS! Database and users created successfully!")
        else:
            print("‚ùå Password test failed")
    else:
        print("‚ùå Test user not found")
    
    # Show all users
    all_users = User.query.all()
    print(f"\nüìä Total users in database: {len(all_users)}")
    
    print("\nüìã All Login Credentials:")
    print("=" * 50)
    for user in all_users:
        print(f"Email: {user.email}")
        print(f"Password: {user.name.split()[0]}@123")
        print(f"Role: {user.role}")
        print("-" * 30)

####################
from flask import Flask, request, jsonify
from flask_sqlalchemy import SQLAlchemy
from flask_cors import CORS
from flask_jwt_extended import JWTManager, create_access_token, jwt_required, get_jwt_identity, verify_jwt_in_request
from flask_bcrypt import Bcrypt
from datetime import datetime, timedelta
import os
from dotenv import load_dotenv

load_dotenv()

app = Flask(__name__)
app.config['SECRET_KEY'] = os.getenv('SECRET_KEY', 'your-secret-key-here')
app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('DATABASE_URL', 'sqlite:///hr_succession.db')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['JWT_SECRET_KEY'] = os.getenv('JWT_SECRET_KEY', 'your-secret-key-here')
app.config['JWT_ACCESS_TOKEN_EXPIRES'] = timedelta(hours=24)

db = SQLAlchemy(app)
jwt = JWTManager(app)
bcrypt = Bcrypt(app)

# Fix CORS configuration
CORS(app, resources={
    r"/*": {
        "origins": ["http://localhost:3000", "http://127.0.0.1:3000"],
        "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
        "allow_headers": ["Content-Type", "Authorization", "Access-Control-Allow-Origin"]
    }
})

# Add CORS headers to all responses
@app.after_request
def after_request(response):
    response.headers.add('Access-Control-Allow-Origin', 'http://localhost:3000')
    response.headers.add('Access-Control-Allow-Headers', 'Content-Type,Authorization')
    response.headers.add('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE,OPTIONS')
    response.headers.add('Access-Control-Allow-Credentials', 'true')
    return response
